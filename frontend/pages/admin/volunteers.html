<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Volunteer Management - Admin</title>
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/layout.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/pages/admin/admin.css">
    <link rel="stylesheet" href="../../css/responsive.css">
</head>
<body class="admin-layout">
<aside class="admin-sidebar">
    <div class="sidebar-logo">Charity Admin</div>

    <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">Dashboard</span>
        </a>
        <a href="projects.html" class="nav-item">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-text">Projects</span>
        </a>
        <a href="events.html" class="nav-item">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-text">Events</span>
        </a>
        <a href="donations.html" class="nav-item">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-text">Donations</span>
        </a>
        <a href="volunteers.html" class="nav-item active">
            <span class="nav-icon">ğŸ¤</span>
            <span class="nav-text">Volunteers</span>
        </a>
        <a href="users.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">Users</span>
        </a>
        <a href="content.html" class="nav-item">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-text">Content</span>
        </a>
        <a href="activity.html" class="nav-item">
            <span class="nav-icon">ğŸ“œ</span>
            <span class="nav-text">Activity Logs</span>
        </a>
        <a href="settings.html" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">Settings</span>
        </a>
    </nav>

    <div class="sidebar-footer">
        <button id="logout-btn" class="nav-item" style="width: 100%; border: none; background: none; cursor: pointer;">
            <span class="nav-icon">ğŸšª</span>
            <span class="nav-text">Logout</span>
        </button>
    </div>
</aside>

<main class="admin-main">
    <header class="admin-header">
        <div class="header-left">
            <span class="breadcrumb">Admin / Volunteers</span>
            <h1>Volunteer Management</h1>
        </div>
        <div class="header-right">
            <div class="user-pill">
                <span id="user-name">Loading...</span>
                <small id="user-role">Super Admin</small>
            </div>
        </div>
    </header>

    <div class="admin-content">
        <div class="admin-card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table" id="volunteers-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Ward</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="volunteers-body">
                            <!-- Volunteer rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Status Update Modal -->
<div id="status-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="status-modal-title">Update Volunteer Status</h2>
                <button class="modal-close" onclick="closeStatusModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="status-form">
                    <input type="hidden" id="volunteer-id">
                    <div class="form-group">
                        <p>Volunteer: <strong id="volunteer-name"></strong></p>
                    </div>
                    <div class="form-group">
                        <label for="volunteer-status">New Status</label>
                        <select id="volunteer-status" name="status" class="form-control">
                            <option value="PENDING">Pending</option>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="SUSPENDED">Suspended</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button type="submit" form="status-form" class="btn btn-primary">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script src="../../js/services/api.service.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadVolunteers();
        document.getElementById('status-form').addEventListener('submit', handleStatusUpdate);
    });

    async function loadVolunteers() {
        const tbody = document.getElementById('volunteers-body');
        tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

        try {
            const volunteers = await adminAPI.get('/volunteers');
            if (!volunteers || volunteers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No volunteers found.</td></tr>';
                return;
            }

            tbody.innerHTML = volunteers.map(v => \`
                <tr data-id="\${v.id}">
                    <td><strong>\${v.name}</strong></td>
                    <td>\${v.email}</td>
                    <td>\${v.ward || '-'}</td>
                    <td><span class="notification-type type-\${v.status === 'ACTIVE' ? 'success' : v.status === 'PENDING' ? 'warning' : 'error'}">\${v.status}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-secondary" onclick="openStatusModal(\${v.id}, '\${v.name}', '\${v.status}')">Update Status</button>
                        <button class="btn btn-sm btn-danger" onclick="suspendVolunteer(\${v.id})">Suspend</button>
                    </td>
                </tr>
            \`).join('');
        } catch (error) {
            tbody.innerHTML = \`<tr><td colspan="5">Error loading volunteers: \${error.message}</td></tr>\`;
        }
    }

    function openStatusModal(id, name, currentStatus) {
        document.getElementById('volunteer-id').value = id;
        document.getElementById('volunteer-name').textContent = name;
        document.getElementById('volunteer-status').value = currentStatus;
        document.getElementById('status-modal').style.display = 'flex';
    }

    function closeStatusModal() {
        document.getElementById('status-modal').style.display = 'none';
    }

    async function handleStatusUpdate(e) {
        e.preventDefault();
        const id = document.getElementById('volunteer-id').value;
        const newStatus = document.getElementById('volunteer-status').value;

        try {
            // The backend PUT /volunteers/{id} expects a VolunteerRequest object.
            // We need to fetch the existing volunteer data first to avoid overwriting fields.
            const volunteer = await adminAPI.get(\`/volunteers/\${id}\`);
            const updatePayload = {
                name: volunteer.name,
                email: volunteer.email,
                phone: volunteer.phone,
                ward: volunteer.ward,
                interests: volunteer.interests,
                skills: volunteer.skills,
                availability: volunteer.availability,
                status: newStatus // The only changed field
            };

            await adminAPI.put(\`/volunteers/\${id}\`, updatePayload);
            alert('Volunteer status updated successfully!');
            closeStatusModal();
            loadVolunteers();
        } catch (error) {
            alert(\`Failed to update status: \${error.message}\`);
        }
    }

    async function suspendVolunteer(id) {
        if (!confirm('Are you sure you want to suspend this volunteer? This is a soft delete.')) return;

        try {
            await adminAPI.delete(\`/volunteers/\${id}\`);
            alert('Volunteer suspended successfully');
            loadVolunteers();
        } catch (error) {
            alert(\`Failed to suspend volunteer: \${error.message}\`);
        }
    }
</script>
</body>
</html>